# 🎨 CIVITAI Orchestrator Mock

Проект имитирует работу реального `orchestration.civitai.com` сервиса 
## 🚀 Быстрый старт

```bash
# Установка зависимостей
npm install

# Настройка переменных окружения
cp .env.example .env

# Запуск API сервера
npm start

# Или запуск всех компонентов (API + Scheduler)
npm run start:monolith
```

## 🏗️ Архитектура

### Обзор системы

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   REST API      │◄──►│    Scheduler     │◄──►│   Generator     │
│  (Express.js)   │    │   (Pipeline)     │    │  (ComfyUI)      │
└─────────────────┘    └──────────────────┘    └─────────────────┘
         │                        │                       │
         ▼                        ▼                       ▼
┌─────────────────────────────────────────────────────────────────┐
│                     MongoDB Database                           │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐   │
│  │ resources   │ │    jobs     │ │      jobEvent          │   │
│  └─────────────┘ └─────────────┘ └─────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### Компоненты

#### 🌐 **API Layer** (`src/api/`)
- **REST API** на Express.js с полной совместимостью Civitai API
- **Роуты**: `/v2/resources` (CRUD ресурсов), `/v1/consumer/jobs` (создание и мониторинг задач)
- **Валидация**: Проверка URN форматов, существования моделей, сжатие идентификаторов

#### 🔄 **Scheduler** (`src/scheduler/`)
- **Автоматическая обработка** задач каждые 2 секунды (настраивается)
- **Pipeline с 4 этапами**: CLAIMED → PROMPT_PREPARED → SENT_TO_COMFY → COMFY_RESULT
- **Подробное логирование** каждого шага с trace_id

#### 🎯 **Generator** (`src/generator/`)
- **Модульная система** адаптеров для разных типов моделей (SD1.5, SDXL, Flux)
- **Скелеты workflow** — переиспользуемые шаблоны для ComfyUI
- **Динамическое создание** ComfyUI workflow на основе параметров задач

#### 🗄️ **База данных** (MongoDB)
- **resources** — AI-ресурсы с уникальными AIR-идентификаторами
- **jobs** — задачи генерации с UUID и временем жизни 24 часа
- **jobEvent** — события жизненного цикла задач с детальной историей

### AIR (AI Resource Identifiers)

Система использует унифицированные URN идентификаторы:

```
Полный формат: urn:air:sdxl:checkpoint:civitai:101055@128078
Сжатый формат: @civitai/128078
```

**Компоненты URN:**
- `ecosystem`: sd1, sdxl, flux1
- `type`: checkpoint, lora, embedding
- `source`: civitai, huggingface
- `id`: уникальный идентификатор модели
- `version`: версия модели

